<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IncidentMap Web - Record (確認してからアップロード)</title>
  <style>
    body { font-family:-apple-system,system-ui,sans-serif; margin:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .btn { padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:8px; }
    .btn.primary { background:#0b5; color:#fff; border-color:#0b5; }
    .btn.danger { background:#e24; color:#fff; border-color:#e24; }
    #previewBox { display:none; margin-top:12px; }
    #previewBox .meta { font-size:12px; color:#555; margin-top:6px; }
    #previewMedia { max-width:100%; width:360px; border-radius:10px; background:#000; }
    textarea { width:100%; max-width:560px; }
    select { padding:6px 8px; }
    #status { color:#666; }
  </style>
</head>
<body>
  <h2>📤 撮影 → 確認 → カテゴリ選択 → アップロード</h2>
  <p>先に <b>カテゴリ</b> を選び、次に <b>撮影</b> してください。撮影後に内容を確認してからアップロードできます。</p>

  <!-- 1) 先にカテゴリ & コメントを決める -->
  <div class="row">
    <label for="category">🗂 カテゴリ</label>
    <select id="category">
      <option value="incident">事件/事故</option>
      <option value="event">イベント/祭り</option>
      <option value="traffic">交通</option>
      <option value="fire">火災</option>
      <option value="disaster">災害</option>
      <option value="police">警察/防犯</option>
      <option value="other" selected>その他</option>
    </select>
  </div>
  <div class="row" style="flex-direction:column;align-items:flex-start;">
    <label for="note">📝 コメント（任意）</label>
    <textarea id="note" rows="3" placeholder="例）〇〇通りで接触事故、軽傷。渋滞発生中など"></textarea>
  </div>

  <!-- 2) 撮影ボタン（この段階ではアップロードしない） -->
  <input id="file" type="file" accept="image/*,video/*" capture="environment" style="display:none" />
  <div class="row">
    <button id="btnShoot" class="btn">📸 撮影する（写真/動画）</button>
    <span id="status"></span>
  </div>

  <!-- 3) 撮影後のプレビュー＆確認ステップ -->
  <div id="previewBox">
    <div class="row" style="margin-top:6px;">
      <b>プレビュー</b><span id="fileInfo" class="meta"></span>
    </div>
    <div>
      <!-- 画像 or 動画をここに差し替え表示 -->
      <img id="previewImg" alt="" style="display:none" />
      <video id="previewVideo" playsinline controls style="display:none"></video>
    </div>
    <div class="meta">位置情報はアップロード時に取得します（許可してください）。</div>

    <div class="row" style="margin-top:10px;">
      <button id="btnRetake" class="btn">↩︎ 撮り直す</button>
      <button id="btnUpload" class="btn primary">⏫ この内容でアップロード</button>
    </div>
  </div>

  <p style="margin-top:16px;"><a href="/map.html">🗺 地図を見る</a></p>

  <script>
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const btnShoot = document.getElementById('btnShoot');
    const btnRetake = document.getElementById('btnRetake');
    const btnUpload = document.getElementById('btnUpload');
    const previewBox = document.getElementById('previewBox');
    const previewImg = document.getElementById('previewImg');
    const previewVideo = document.getElementById('previewVideo');
    const fileInfo = document.getElementById('fileInfo');
    const noteEl = document.getElementById('note');
    const catEl = document.getElementById('category');

    let selectedFile = null;
    let objectUrl = null;

    btnShoot.onclick = () => {
      // ここではアップロードしない：撮影だけ
      fileInput.click();
    };

    fileInput.onchange = () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      selectedFile = f;

      // プレビューを出す（動画/画像で切替）
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(f);

      const isImage = f.type.startsWith('image/');
      previewImg.style.display = isImage ? 'block' : 'none';
      previewVideo.style.display = isImage ? 'none' : 'block';

      if (isImage) {
        previewImg.id = 'previewMedia';
        previewImg.src = objectUrl;
      } else {
        previewVideo.id = 'previewMedia';
        previewVideo.src = objectUrl;
      }

      fileInfo.textContent = `（${f.type || '不明'} / ${Math.round((f.size||0)/1024)}KB）`;
      previewBox.style.display = 'block';
      statusEl.textContent = '撮影内容を確認してください。';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    btnRetake.onclick = () => {
      // 撮り直し：状態をクリアして再度撮影へ
      selectedFile = null;
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = null;
      previewImg.removeAttribute('src');
      previewVideo.removeAttribute('src');
      previewBox.style.display = 'none';
      statusEl.textContent = 'もう一度撮影できます。';
      fileInput.value = '';
      fileInput.click();
    };

    btnUpload.onclick = async () => {
      if (!selectedFile) {
        alert('ファイルが選ばれていません');
        return;
      }
      statusEl.textContent = '位置情報取得中…（許可してください）';

      const pos = await new Promise(res =>
        navigator.geolocation.getCurrentPosition(p => res(p), _ => res(null), { enableHighAccuracy:true, timeout:8000 })
      );

      statusEl.textContent = 'アップロード中…';
      const fd = new FormData();
      fd.append('lat', pos?.coords?.latitude ?? 0);
      fd.append('lon', pos?.coords?.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords?.accuracy ?? 0));
      fd.append('note', noteEl.value || '');
      fd.append('category', catEl.value || 'other');
      fd.append('file', selectedFile, selectedFile.name || 'media');

      try {
        const r = await fetch('/upload', { method: 'POST', body: fd });
        const t = await r.json().catch(()=>({}));
        if (t.ok) {
          statusEl.textContent = 'アップロード完了！';
          alert('アップロード完了！地図で確認できます。');
          location.href = '/map.html';
        } else {
          throw new Error(t.error || 'アップロード失敗');
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = '失敗しました';
        alert('アップロードに失敗しました: ' + e.message);
      }
    };
  </script>
</body>
</html>





