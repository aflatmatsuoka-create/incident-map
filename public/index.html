<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IncidentMap Web - Record (iPhone)</title>
</head>
<body style="font-family: -apple-system, system-ui; margin: 16px;">
  <h2>ğŸ¥ æ’®å½±ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆiPhoneï¼‰</h2>
  <p>ã€ŒğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ <b>ã€å†™çœŸ/ãƒ“ãƒ‡ã‚ªã‚’æ’®ã‚‹ã€</b> ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>

  <input id="file" type="file" accept="video/*" capture="environment" style="display:none">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button id="pick" style="padding:10px 16px">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã™ã‚‹</button>
    <span id="status" style="color:#666"></span>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    document.getElementById('pick').onclick = () => fileInput.click();

    fileInput.onchange = async () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      statusEl.textContent = 'ä½ç½®æƒ…å ±å–å¾—ä¸­â€¦';
      const pos = await new Promise(res => navigator.geolocation.getCurrentPosition(p => res(p), _ => res(null)));

      statusEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
      const fd = new FormData();
      fd.append('lat', pos?.coords.latitude ?? 0);
      fd.append('lon', pos?.coords.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords.accuracy ?? 0));
      fd.append('video', file, file.name || 'video.mov');

      const r = await fetch('/upload', { method: 'POST', body: fd });
      const t = await r.text();
      statusEl.textContent = t.includes('"ok"') ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼' : t;
      if (t.includes('"ok"')) alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼â†’ åœ°å›³ã§ç¢ºèªã—ã¦ãã ã•ã„');
    };
  </script>

  <p style="margin-top:16px;"><a href="/map.html">ğŸ—º åœ°å›³ã‚’è¦‹ã‚‹</a></p>
</body>
</html>
