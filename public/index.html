<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IncidentMap Web - Record (é€²æ—+é‡è¤‡ã‚¬ãƒ¼ãƒ‰)</title>
  <style>
    body { font-family:-apple-system,system-ui,sans-serif; margin:16px; }
    .btn { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#0b5; color:#fff; border-color:#0b5; }
    #previewBox { display:none; margin-top:12px; }
    #uploadingScreen {
      position: fixed; inset:0; background: rgba(255,255,255,.95);
      display:none; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      backdrop-filter: blur(6px);
    }
    .progressbar { width: 80%; max-width:300px; height:16px; border:1px solid #aaa; border-radius:8px; overflow:hidden; }
    .progressbar-inner { height:100%; width:0%; background:#0b5; transition:width .2s; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ æ’®å½±â†’ç¢ºèªâ†’ã‚«ãƒ†ã‚´ãƒªâ†’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

  <label>ğŸ—‚ ã‚«ãƒ†ã‚´ãƒª</label><br>
  <select id="category">
    <option value="incident">äº‹ä»¶/äº‹æ•…</option>
    <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆ/ç¥­ã‚Š</option>
    <option value="traffic">äº¤é€š</option>
    <option value="fire">ç«ç½</option>
    <option value="disaster">ç½å®³</option>
    <option value="police">è­¦å¯Ÿ/é˜²çŠ¯</option>
    <option value="other" selected>ãã®ä»–</option>
  </select><br><br>

  <label>ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ</label><br>
  <textarea id="note" rows="3" style="width:100%"></textarea><br><br>

  <input id="file" type="file" accept="image/*,video/*" capture="environment" style="display:none" />
  <button id="btnShoot" class="btn">ğŸ“¸ æ’®å½±ã™ã‚‹</button>

  <div id="previewBox">
    <p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
    <img id="previewImg" style="max-width:100%;display:none" />
    <video id="previewVideo" style="max-width:100%;display:none" controls></video><br>
    <button id="btnUpload" class="btn primary">â« ã“ã®å†…å®¹ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  </div>

  <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ç”»é¢ -->
  <div id="uploadingScreen">
    <div>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦ <span id="progressText">0%</span></div>
    <div class="progressbar"><div id="progressBar" class="progressbar-inner"></div></div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const btnShoot = document.getElementById('btnShoot');
    const btnUpload = document.getElementById('btnUpload');
    const previewBox = document.getElementById('previewBox');
    const previewImg = document.getElementById('previewImg');
    const previewVideo = document.getElementById('previewVideo');
    const catEl = document.getElementById('category');
    const noteEl = document.getElementById('note');
    const uploadingScreen = document.getElementById('uploadingScreen');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    let selectedFile = null;

    btnShoot.onclick = () => fileInput.click();
    fileInput.onchange = () => {
      const f = fileInput.files[0];
      if (!f) return;
      selectedFile = f;
      const url = URL.createObjectURL(f);
      if (f.type.startsWith('image/')) {
        previewImg.src = url; previewImg.style.display='block';
        previewVideo.style.display='none';
      } else {
        previewVideo.src = url; previewVideo.style.display='block';
        previewImg.style.display='none';
      }
      previewBox.style.display='block';
    };

    btnUpload.onclick = async () => {
      if (!selectedFile) return;
      uploadingScreen.style.display='flex';
      progressBar.style.width = '0%';
      progressText.textContent = '0%';

      const pos = await new Promise(res =>
        navigator.geolocation.getCurrentPosition(p=>res(p),_=>res(null))
      );

      const fd = new FormData();
      fd.append('lat', pos?.coords?.latitude ?? 0);
      fd.append('lon', pos?.coords?.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords?.accuracy ?? 0));
      fd.append('note', noteEl.value || '');
      fd.append('category', catEl.value || 'other');
      fd.append('file', selectedFile, selectedFile.name||'media');

      const xhr = new XMLHttpRequest();
      xhr.open('POST','/upload');
      xhr.upload.onprogress = e=>{
        if(e.lengthComputable){
          const percent = Math.round((e.loaded/e.total)*100);
          progressBar.style.width = percent+'%';
          progressText.textContent = percent+'%';
        }
      };
      xhr.onload = ()=>{
        try{
          const t=JSON.parse(xhr.responseText);
          if(t.ok){
            if(t.duplicate){
              alert('åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã§ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ã™ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚');
            }
            location.replace('/map.html');
          } else {
            alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: '+(t.error||'ä¸æ˜'));
            uploadingScreen.style.display='none';
          }
        }catch(e){
          alert('ã‚µãƒ¼ãƒå¿œç­”ã‚¨ãƒ©ãƒ¼');
          uploadingScreen.style.display='none';
        }
      };
      xhr.onerror = ()=>{alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); uploadingScreen.style.display='none';};
      xhr.send(fd);
    };
  </script>
</body>
</html>







