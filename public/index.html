<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IncidentMap Web - Record (ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)</title>
  <style>
    body { font-family:-apple-system,system-ui,sans-serif; margin:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .btn { padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:8px; }
    .btn.primary { background:#0b5; color:#fff; border-color:#0b5; }
    .btn.danger { background:#e24; color:#fff; border-color:#e24; }
    #previewBox { display:none; margin-top:12px; }
    #previewBox .meta { font-size:12px; color:#555; margin-top:6px; }
    #previewMedia { max-width:100%; width:360px; border-radius:10px; background:#000; }
    textarea { width:100%; max-width:560px; }
    select { padding:6px 8px; }
    #status { color:#666; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ æ’®å½± â†’ ç¢ºèª â†’ ã‚«ãƒ†ã‚´ãƒªé¸æŠ â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
  <p>å…ˆã« <b>ã‚«ãƒ†ã‚´ãƒª</b> ã‚’é¸ã³ã€æ¬¡ã« <b>æ’®å½±</b> ã—ã¦ãã ã•ã„ã€‚æ’®å½±å¾Œã«å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>

  <!-- 1) å…ˆã«ã‚«ãƒ†ã‚´ãƒª & ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ±ºã‚ã‚‹ -->
  <div class="row">
    <label for="category">ğŸ—‚ ã‚«ãƒ†ã‚´ãƒª</label>
    <select id="category">
      <option value="incident">äº‹ä»¶/äº‹æ•…</option>
      <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆ/ç¥­ã‚Š</option>
      <option value="traffic">äº¤é€š</option>
      <option value="fire">ç«ç½</option>
      <option value="disaster">ç½å®³</option>
      <option value="police">è­¦å¯Ÿ/é˜²çŠ¯</option>
      <option value="other" selected>ãã®ä»–</option>
    </select>
  </div>
  <div class="row" style="flex-direction:column;align-items:flex-start;">
    <label for="note">ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
    <textarea id="note" rows="3" placeholder="ä¾‹ï¼‰ã€‡ã€‡é€šã‚Šã§æ¥è§¦äº‹æ•…ã€è»½å‚·ã€‚æ¸‹æ»ç™ºç”Ÿä¸­ãªã©"></textarea>
  </div>

  <!-- 2) æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆã“ã®æ®µéšã§ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼‰ -->
  <input id="file" type="file" accept="image/*,video/*" capture="environment" style="display:none" />
  <div class="row">
    <button id="btnShoot" class="btn">ğŸ“¸ æ’®å½±ã™ã‚‹ï¼ˆå†™çœŸ/å‹•ç”»ï¼‰</button>
    <span id="status"></span>
  </div>

  <!-- 3) æ’®å½±å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç¢ºèªã‚¹ãƒ†ãƒƒãƒ— -->
  <div id="previewBox">
    <div class="row" style="margin-top:6px;">
      <b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</b><span id="fileInfo" class="meta"></span>
    </div>
    <div>
      <!-- ç”»åƒ or å‹•ç”»ã‚’ã“ã“ã«å·®ã—æ›¿ãˆè¡¨ç¤º -->
      <img id="previewImg" alt="" style="display:none" />
      <video id="previewVideo" playsinline controls style="display:none"></video>
    </div>
    <div class="meta">ä½ç½®æƒ…å ±ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«å–å¾—ã—ã¾ã™ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰ã€‚</div>

    <div class="row" style="margin-top:10px;">
      <button id="btnRetake" class="btn">â†©ï¸ æ’®ã‚Šç›´ã™</button>
      <button id="btnUpload" class="btn primary">â« ã“ã®å†…å®¹ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  </div>

  <p style="margin-top:16px;"><a href="/map.html">ğŸ—º åœ°å›³ã‚’è¦‹ã‚‹</a></p>

  <script>
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const btnShoot = document.getElementById('btnShoot');
    const btnRetake = document.getElementById('btnRetake');
    const btnUpload = document.getElementById('btnUpload');
    const previewBox = document.getElementById('previewBox');
    const previewImg = document.getElementById('previewImg');
    const previewVideo = document.getElementById('previewVideo');
    const fileInfo = document.getElementById('fileInfo');
    const noteEl = document.getElementById('note');
    const catEl = document.getElementById('category');

    let selectedFile = null;
    let objectUrl = null;

    btnShoot.onclick = () => {
      // ã“ã“ã§ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼šæ’®å½±ã ã‘
      fileInput.click();
    };

    fileInput.onchange = () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      selectedFile = f;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‡ºã™ï¼ˆå‹•ç”»/ç”»åƒã§åˆ‡æ›¿ï¼‰
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(f);

      const isImage = f.type.startsWith('image/');
      previewImg.style.display = isImage ? 'block' : 'none';
      previewVideo.style.display = isImage ? 'none' : 'block';

      if (isImage) {
        previewImg.id = 'previewMedia';
        previewImg.src = objectUrl;
      } else {
        previewVideo.id = 'previewMedia';
        previewVideo.src = objectUrl;
      }

      fileInfo.textContent = `ï¼ˆ${f.type || 'ä¸æ˜'} / ${Math.round((f.size||0)/1024)}KBï¼‰`;
      previewBox.style.display = 'block';
      statusEl.textContent = 'æ’®å½±å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    btnRetake.onclick = () => {
      // æ’®ã‚Šç›´ã—ï¼šçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†åº¦æ’®å½±ã¸
      selectedFile = null;
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = null;
      previewImg.removeAttribute('src');
      previewVideo.removeAttribute('src');
      previewBox.style.display = 'none';
      statusEl.textContent = 'ã‚‚ã†ä¸€åº¦æ’®å½±ã§ãã¾ã™ã€‚';
      fileInput.value = '';
      fileInput.click();
    };

    btnUpload.onclick = async () => {
      if (!selectedFile) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      statusEl.textContent = 'ä½ç½®æƒ…å ±å–å¾—ä¸­â€¦ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰';

      const pos = await new Promise(res =>
        navigator.geolocation.getCurrentPosition(p => res(p), _ => res(null), { enableHighAccuracy:true, timeout:8000 })
      );

      statusEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
      const fd = new FormData();
      fd.append('lat', pos?.coords?.latitude ?? 0);
      fd.append('lon', pos?.coords?.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords?.accuracy ?? 0));
      fd.append('note', noteEl.value || '');
      fd.append('category', catEl.value || 'other');
      fd.append('file', selectedFile, selectedFile.name || 'media');

      try {
        const r = await fetch('/upload', { method: 'POST', body: fd });
        const t = await r.json().catch(()=>({}));
        if (t.ok) {
          statusEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
          alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼åœ°å›³ã§ç¢ºèªã§ãã¾ã™ã€‚');
          location.href = '/map.html';
        } else {
          throw new Error(t.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'å¤±æ•—ã—ã¾ã—ãŸ';
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
  </script>
</body>
</html>





