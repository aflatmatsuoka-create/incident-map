<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IncidentMap Web - Record (iPhone)</title>
</head>
<body style="font-family: -apple-system, system-ui, sans-serif; margin:16px;">
  <h2>📤 撮影してアップロード（iPhone推奨）</h2>
  <p>「メディアを選ぶ」で <b>写真またはビデオ</b> を選択してください。位置情報は<b>許可</b>してください。</p>

  <input id="file" type="file" accept="image/*,video/*" capture="environment" style="display:none" />

  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
    <button id="pick" style="padding:10px 16px;">📁 メディアを選ぶ</button>
    <span id="status" style="color:#666"></span>
  </div>

  <label>📝 コメント（任意）</label><br>
  <textarea id="note" rows="3" style="width:100%;max-width:560px;"></textarea>

  <script>
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const noteEl = document.getElementById('note');
    document.getElementById('pick').onclick = () => fileInput.click();

    fileInput.onchange = async () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      statusEl.textContent = '位置情報取得中…';
      const pos = await new Promise(res =>
        navigator.geolocation.getCurrentPosition(p => res(p), _ => res(null))
      );

      statusEl.textContent = 'アップロード中…';
      const fd = new FormData();
      fd.append('lat', pos?.coords.latitude ?? 0);
      fd.append('lon', pos?.coords.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords.accuracy ?? 0));
      fd.append('note', noteEl.value || '');
      // フィールド名は何でもOK（サーバ側は any で受領）
      fd.append('file', file, file.name || 'media');

      const r = await fetch('/upload', { method: 'POST', body: fd });
      const t = await r.json().catch(() => ({}));
      statusEl.textContent = t.ok ? 'アップロード完了！' : ('失敗: ' + (t.error || '不明'));
      if (t.ok) {
        alert('アップロード完了！地図に反映されます。');
        location.href = '/map.html';
      } else {
        alert('アップロード失敗: ' + (t.error || '不明'));
      }
    };
  </script>

  <p style="margin-top:16px;"><a href="/map.html">🗺 地図を見る</a></p>
</body>
</html>


