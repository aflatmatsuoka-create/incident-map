<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IncidentMap Web - Record (ç¢ºèªâ†’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family:-apple-system,system-ui,sans-serif; margin:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .btn { padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn.primary { background:#0b5; color:#fff; border-color:#0b5; }
    #previewBox { display:none; margin-top:12px; }
    #previewBox .meta { font-size:12px; color:#555; margin-top:6px; }
    #previewMedia { max-width:100%; width:360px; border-radius:10px; background:#000; }
    textarea { width:100%; max-width:560px; }
    select { padding:6px 8px; }
    #status { color:#666; }

    /* â”€â”€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ï¼ˆåˆ¥ç”»é¢é¢¨ï¼‰ â”€â”€ */
    #uploadingScreen {
      position: fixed; inset: 0; background: rgba(255,255,255,.98);
      display: none; align-items: center; justify-content: center; flex-direction: column;
      gap: 14px; text-align: center; padding: 24px;
      backdrop-filter: blur(6px);
    }
    @media (prefers-color-scheme: dark){
      #uploadingScreen { background: rgba(0,0,0,.85); color:#fff; }
    }
    .spinner {
      width: 40px; height: 40px; border-radius: 50%;
      border: 4px solid #ddd; border-top-color: #0b5; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sub { color:#666; font-size: 13px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ æ’®å½± â†’ ç¢ºèª â†’ ã‚«ãƒ†ã‚´ãƒªé¸æŠ â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ï¼‰ -->
  <div id="formArea">
    <p>å…ˆã« <b>ã‚«ãƒ†ã‚´ãƒª</b> ã‚’é¸ã³ã€æ¬¡ã« <b>æ’®å½±</b> ã—ã¦ãã ã•ã„ã€‚æ’®å½±å¾Œã«ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>

    <div class="row">
      <label for="category">ğŸ—‚ ã‚«ãƒ†ã‚´ãƒª</label>
      <select id="category">
        <option value="incident">äº‹ä»¶/äº‹æ•…</option>
        <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆ/ç¥­ã‚Š</option>
        <option value="traffic">äº¤é€š</option>
        <option value="fire">ç«ç½</option>
        <option value="disaster">ç½å®³</option>
        <option value="police">è­¦å¯Ÿ/é˜²çŠ¯</option>
        <option value="other" selected>ãã®ä»–</option>
      </select>
    </div>

    <div class="row" style="flex-direction:column;align-items:flex-start;">
      <label for="note">ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
      <textarea id="note" rows="3" placeholder="ä¾‹ï¼‰ã€‡ã€‡é€šã‚Šã§æ¥è§¦äº‹æ•…ã€è»½å‚·ã€‚æ¸‹æ»ç™ºç”Ÿä¸­ãªã©"></textarea>
    </div>

    <input id="file" type="file" accept="image/*,video/*" capture="environment" style="display:none" />
    <div class="row">
      <button id="btnShoot" class="btn">ğŸ“¸ æ’®å½±ã™ã‚‹ï¼ˆå†™çœŸ/å‹•ç”»ï¼‰</button>
      <span id="status"></span>
    </div>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç¢ºèªã‚¹ãƒ†ãƒƒãƒ— -->
  <div id="previewBox">
    <div class="row" style="margin-top:6px;">
      <b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</b><span id="fileInfo" class="meta"></span>
    </div>
    <div>
      <img id="previewImg" alt="" style="display:none" />
      <video id="previewVideo" playsinline controls style="display:none"></video>
    </div>
    <div class="meta">ä½ç½®æƒ…å ±ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«å–å¾—ã—ã¾ã™ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰ã€‚</div>

    <div class="row" style="margin-top:10px;">
      <button id="btnRetake" class="btn">â†©ï¸ æ’®ã‚Šç›´ã™</button>
      <button id="btnUpload" class="btn primary">â« ã“ã®å†…å®¹ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  </div>

  <p style="margin-top:16px;"><a href="/map.html">ğŸ—º åœ°å›³ã‚’è¦‹ã‚‹</a></p>

  <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ ç”»é¢ -->
  <div id="uploadingScreen" aria-live="polite">
    <div class="spinner" role="progressbar" aria-label="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­"></div>
    <div style="font-weight:600">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</div>
    <div class="sub">ã“ã®ç”»é¢ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚å®Œäº†ã™ã‚‹ã¨è‡ªå‹•ã§åœ°å›³ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
    <button id="btnCancel" class="btn" style="display:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <script>
    // è¦ç´ 
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const btnShoot = document.getElementById('btnShoot');
    const btnRetake = document.getElementById('btnRetake');
    const btnUpload = document.getElementById('btnUpload');
    const previewBox = document.getElementById('previewBox');
    const previewImg = document.getElementById('previewImg');
    const previewVideo = document.getElementById('previewVideo');
    const fileInfo = document.getElementById('fileInfo');
    const noteEl = document.getElementById('note');
    const catEl = document.getElementById('category');
    const formArea = document.getElementById('formArea');
    const uploadingScreen = document.getElementById('uploadingScreen');

    let selectedFile = null;
    let objectUrl = null;
    let isUploading = false;
    let aborter = null;

    // æ’®å½±
    btnShoot.onclick = () => fileInput.click();

    fileInput.onchange = () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      selectedFile = f;

      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(f);
      const isImage = f.type.startsWith('image/');

      previewImg.style.display = isImage ? 'block' : 'none';
      previewVideo.style.display = isImage ? 'none' : 'block';
      if (isImage) {
        previewImg.id = 'previewMedia';
        previewImg.src = objectUrl;
      } else {
        previewVideo.id = 'previewMedia';
        previewVideo.src = objectUrl;
      }

      fileInfo.textContent = `ï¼ˆ${f.type || 'ä¸æ˜'} / ${Math.round((f.size||0)/1024)}KBï¼‰`;
      previewBox.style.display = 'block';
      statusEl.textContent = 'æ’®å½±å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    // æ’®ã‚Šç›´ã—
    btnRetake.onclick = () => {
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = null;
      selectedFile = null;
      previewImg.removeAttribute('src');
      previewVideo.removeAttribute('src');
      previewBox.style.display = 'none';
      statusEl.textContent = 'ã‚‚ã†ä¸€åº¦æ’®å½±ã§ãã¾ã™ã€‚';
      fileInput.value = '';
      fileInput.click();
    };

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆåˆ¥ç”»é¢é¢¨ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
    btnUpload.onclick = async () => {
      if (!selectedFile || isUploading) return;
      isUploading = true;
      btnUpload.disabled = true;
      btnRetake.disabled = true;

      // URL ã‚’ /uploading ã«å¤‰æ›´ï¼ˆâ€œç”»é¢é·ç§»â€ã®è¦‹ãŸç›®ï¼‰
      history.pushState({ uploading: true }, '', '/uploading');
      showUploading(true);

      // ä½ç½®æƒ…å ±
      statusEl.textContent = 'ä½ç½®æƒ…å ±å–å¾—ä¸­â€¦';
      const pos = await new Promise(res =>
        navigator.geolocation.getCurrentPosition(p => res(p), _ => res(null), { enableHighAccuracy:true, timeout:8000 })
      );

      // é€ä¿¡
      const fd = new FormData();
      fd.append('lat', pos?.coords?.latitude ?? 0);
      fd.append('lon', pos?.coords?.longitude ?? 0);
      fd.append('captured_at', new Date().toISOString());
      fd.append('accuracy', Math.round(pos?.coords?.accuracy ?? 0));
      fd.append('note', noteEl.value || '');
      fd.append('category', catEl.value || 'other');
      fd.append('file', selectedFile, selectedFile.name || 'media');

      try {
        aborter = new AbortController();
        const r = await fetch('/upload', { method: 'POST', body: fd, signal: aborter.signal });
        const t = await r.json().catch(()=>({}));
        if (t.ok) {
          // å®Œäº† â†’ ãƒãƒƒãƒ—ã¸
          location.replace('/map.html');
        } else {
          throw new Error(t.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
        }
      } catch (e) {
        console.error(e);
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        // å¤±æ•—ã—ãŸã‚‰å…ƒã®URLã«æˆ»ã™
        history.replaceState({}, '', '/');
        showUploading(false);
        isUploading = false;
        btnUpload.disabled = false;
        btnRetake.disabled = false;
      } finally {
        aborter = null;
      }
    };

    // â€œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢â€ã®è¡¨ç¤ºåˆ‡æ›¿
    function showUploading(on){
      uploadingScreen.style.display = on ? 'flex' : 'none';
      formArea.style.pointerEvents = on ? 'none' : 'auto';
      previewBox.style.pointerEvents = on ? 'none' : 'auto';
    }

    // ã‚‚ã— /uploading ã§ãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå ´åˆã®æ‰±ã„
    if (location.pathname === '/uploading') {
      // å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ãªã‘ã‚Œã°ãƒˆãƒƒãƒ—ã¸æˆ»ã™
      if (!isUploading) {
        history.replaceState({}, '', '/');
      }
      showUploading(isUploading);
    }

    // ï¼ˆä»»æ„ï¼‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã„å ´åˆã®å‡¦ç†
    document.getElementById('btnCancel').onclick = () => {
      if (aborter) aborter.abort();
      history.replaceState({}, '', '/');
      showUploading(false);
      isUploading = false;
      btnUpload.disabled = false;
      btnRetake.disabled = false;
    };
  </script>
</body>
</html>






